{% extends "base.html" %}
{% import "svgs.html" as svgs %}
{% import "macros.html" as macros %}

{% block title %}All Projects - {{ config.title }}{% endblock title %}

{% block content %}
{% set projects_section = get_section(path="projects/_index.md") %}
{% set projects = projects_section.pages %}
<section class="pt-32 pb-20 px-4 sm:px-6 lg:px-8 max-w-5xl mx-auto min-h-screen" aria-labelledby="all-projects-heading">
    <div class="mb-12">
        <a href="{{ get_url(path="/") }}" class="inline-flex items-center gap-2 text-indigo-400 hover:text-indigo-300 font-mono text-sm mb-6 transition-colors group">
            {{ svgs::arrow_left_icon(class="w-4 h-4 group-hover:-translate-x-1 transition-transform") }}
            Back to Home
        </a>
        <h1 id="all-projects-heading" class="text-4xl font-bold text-white mb-6 tracking-tight">All Projects</h1>
        <p class="text-slate-400 text-lg mb-8">
            A list of my public software and hardware projects.<br>
            Based on my <a href="{{ config.extra.github }}?tab=repositories" class="text-indigo-400 hover:text-indigo-300 transition-colors">GitHub repositories</a>.
        </p>
        <div id="filters" class="flex flex-wrap gap-2" role="group" aria-label="Filter by technology"></div>
    </div>

    {% if projects %}
    <div class="mb-16" id="pinned-section">
        <div class="flex items-center mb-8">
            <h2 class="text-2xl font-bold text-white mr-4"><span class="font-mono text-indigo-400 text-xl mr-2 section-num">01.</span>Featured Projects</h2>
            <div class="h-px bg-slate-800 flex-grow" aria-hidden="true"></div>
        </div>
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
            {% for p in projects %}{{ macros::project_card(project=p, class="pinned project-card", extra_attrs='data-url="' ~ p.extra.github_url ~ '"') }}{% endfor %}
        </div>
    </div>
    {% endif %}

    <div id="repos-section">
        <div class="flex items-center mb-8">
            <h2 class="text-2xl font-bold text-white mr-4">
                <span class="font-mono text-indigo-400 text-xl mr-2 section-num">{% if projects %}02.{% else %}01.{% endif %}</span>Other Repositories
            </h2>
            <div class="h-px bg-slate-800 flex-grow" aria-hidden="true"></div>
        </div>
        <div id="repos" class="grid gap-8 md:grid-cols-2 lg:grid-cols-3" aria-live="polite">
            <p class="col-span-full text-center text-slate-500 py-12 animate-pulse font-mono">Fetching from GitHub...</p>
        </div>
    </div>
</section>

<script>
(function() {
    'use strict';
    const USER = 'ad-oliviero', CACHE_KEY = 'gh_repos', TTL = 3600000;
    const $ = s => document.querySelector(s), $$ = s => document.querySelectorAll(s);
    const esc = t => Object.assign(document.createElement('div'), {textContent: t}).innerHTML;
    
    const ICONS = {
        star: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>',
        link: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>',
        play: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',
        phone: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3"/></svg>',
        term: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z"/></svg>',
        globe: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 21a9 9 0 100-18 9 9 0 000 18zm0-18c2.5 0 4.5 4 4.5 9s-2 9-4.5 9-4.5-4-4.5-9 2-9 4.5-9z"/></svg>',
        chip: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 19.5V21M12 3v1.5m0 15V21m3.75-18v1.5m0 15V21m-9-1.5h10.5a2.25 2.25 0 002.25-2.25V6.75a2.25 2.25 0 00-2.25-2.25H6.75A2.25 2.25 0 004.5 6.75v10.5a2.25 2.25 0 002.25 2.25z"/></svg>',
        folder: '<svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg>'
    };

    const langIcon = l => {
        l = (l || '').toLowerCase();
        if (/swift|kotlin|dart|flutter/.test(l)) return ICONS.phone;
        if (/html|css|javascript|typescript|react|vue/.test(l)) return ICONS.globe;
        if (/^c$|c\+\+|rust|go|python|shell/.test(l)) return ICONS.term;
        if (/verilog|vhdl|assembly/.test(l)) return ICONS.chip;
        return ICONS.folder;
    };

    const card = r => {
        const el = document.createElement('article');
        el.className = 'group bg-slate-800 rounded-lg p-6 hover:-translate-y-2 transition-transform duration-300 border border-slate-700 shadow-lg flex flex-col h-full project-card relative';
        el.dataset.tags = (r.language || '').toLowerCase();
        el.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <div class="text-indigo-400 group-hover:text-indigo-300 transition-colors">${langIcon(r.language)}</div>
                <div class="flex items-center gap-3 z-10">
                    ${r.homepage ? `<a href="${esc(r.homepage)}" target="_blank" rel="noopener noreferrer" class="text-slate-500 hover:text-indigo-400 transition-colors">${ICONS.play}</a>` : ''}
                    ${r.stargazers_count ? `<span class="flex items-center gap-1 text-yellow-500 text-xs font-mono">${ICONS.star}${r.stargazers_count}</span>` : ''}
                    <a href="${esc(r.html_url)}" target="_blank" rel="noopener noreferrer" class="text-slate-500 hover:text-indigo-400 transition-colors">${ICONS.link}</a>
                </div>
            </div>
            <h3 class="text-xl font-bold text-white mb-2 group-hover:text-indigo-400 transition-colors break-words">
                <a href="${esc(r.html_url)}" target="_blank" rel="noopener noreferrer" class="after:absolute after:inset-0">${esc(r.name)}</a>
            </h3>
            <p class="text-slate-400 text-sm mb-4 flex-grow line-clamp-3">${esc(r.description || 'No description.')}</p>
            ${r.language ? `<span class="font-mono text-xs text-slate-500 mt-4">${esc(r.language)}</span>` : ''}`;
        return el;
    };

    let filter = 'All';
    const updateUI = () => {
        $$('.project-card').forEach(c => c.style.display = filter === 'All' || c.dataset.tags.includes(filter.toLowerCase()) ? 'flex' : 'none');
        let n = 1;
        ['pinned', 'repos'].forEach(id => {
            const sec = $(`#${id}-section`);
            if (!sec) return;
            const vis = [...sec.querySelectorAll('.project-card')].some(c => c.style.display !== 'none');
            sec.style.display = vis ? 'block' : 'none';
            if (vis) sec.querySelector('.section-num').textContent = `0${n++}.`;
        });
    };

    const renderFilters = () => {
        const tags = new Set();
        $$('.project-card').forEach(c => c.dataset.tags.split(',').forEach(t => t && tags.add(t)));
        $('#filters').innerHTML = ['All', ...Array.from(tags).sort()].map(t =>
            `<button class="px-3 py-1 text-sm rounded-full border font-mono transition-colors ${t === filter ? 'bg-indigo-500/10 border-indigo-500 text-indigo-400' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500'}">${esc(t)}</button>`
        ).join('');
        $('#filters').querySelectorAll('button').forEach(b => b.onclick = () => { filter = b.textContent; renderFilters(); updateUI(); });
    };

    (async () => {
        const pinned = new Set([...$$('.pinned')].map(e => e.dataset.url?.toLowerCase().replace(/\/$/, '')).filter(Boolean));
        try {
            let cache = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
            if (!cache || Date.now() - cache.ts > TTL) {
                const res = await fetch(`https://api.github.com/users/${USER}/repos?sort=pushed&per_page=100`);
                if (!res.ok) throw new Error();
                cache = { ts: Date.now(), data: await res.json() };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            }
            const repos = cache.data.filter(r => !r.fork && !pinned.has(r.html_url.toLowerCase().replace(/\/$/, '')))
                .sort((a, b) => b.stargazers_count - a.stargazers_count || new Date(b.pushed_at) - new Date(a.pushed_at));
            const cont = $('#repos');
            cont.innerHTML = repos.length ? '' : '<p class="col-span-full text-center text-slate-500 py-12 font-mono">No repositories found.</p>';
            repos.forEach(r => cont.appendChild(card(r)));
            renderFilters(); updateUI();
        } catch { $('#repos').innerHTML = '<p class="col-span-full text-center text-red-400 py-12 font-mono">Failed to load from GitHub.</p>'; }
    })();
})();
</script>
{% endblock content %}
